<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="https://avatars3.githubusercontent.com/u/13956214?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="https://avatars3.githubusercontent.com/u/13956214?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="https://avatars3.githubusercontent.com/u/13956214?v=6.3.0">


  <link rel="mask-icon" href="https://avatars3.githubusercontent.com/u/13956214?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="有时候读书是一种巧妙地避开思考的方法">
<meta property="og:type" content="website">
<meta property="og:title" content="汤~">
<meta property="og:url" content="https://tangbl93.github.io/index.html">
<meta property="og:site_name" content="汤~">
<meta property="og:description" content="有时候读书是一种巧妙地避开思考的方法">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="汤~">
<meta name="twitter:description" content="有时候读书是一种巧妙地避开思考的方法">



  <link rel="alternate" href="/atom.xml" title="汤~" type="application/atom+xml" />




  <link rel="canonical" href="https://tangbl93.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>汤~</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=96340554-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '96340554-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">汤~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/12/02/iap-issues/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/02/iap-issues/" itemprop="url">
                  内购丢单问题解决方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-02 08:21:32" itemprop="dateCreated datePublished" datetime="2018-12-02T08:21:32+00:00">2018-12-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="内购丢单问题解决方案"><a href="#内购丢单问题解决方案" class="headerlink" title="内购丢单问题解决方案"></a>内购丢单问题解决方案</h1><blockquote>
<p>截止到今天为止,该方案已在线上运行大概4个月左右，目前没有收到用户反馈有丢单问题。</p>
</blockquote>
<h2 id="之前的处理流程"><a href="#之前的处理流程" class="headerlink" title="之前的处理流程"></a>之前的处理流程</h2><blockquote>
<p>其实之前我在网上查询怎么做内购的时候，发现大部分文章都是介绍的这种方法。</p>
</blockquote>
<ol>
<li>通过服务器创建一个订单，并获取到 trade_no(订单号)，(total_fee订单金额)等数据</li>
<li>请求内购产品信息，并将 trade_no,total_fee等 绑定到 transaction.payment.applicationUsername 上</li>
<li>发起内购支付请求，并监听到内购支付的状态变化</li>
<li>在支付成功状态后将 receipt 缓存起来，并执行 finishTransaction 操作</li>
<li>将 receipt 等数据传给服务器做支付校验，服务器通过请求苹果后台做校验判断是否真实的支付</li>
<li>在服务器校验成功后，将本地缓存清除</li>
<li>如果有丢单情况，会在启动时从缓存中读取 receipt 去执行第4步</li>
</ol>
<p>实际上，这套方案看似没什么问题。但是还是频繁收到用户反馈说有丢单，然后就有了之后的优化。</p>
<p>从我个人的经验来分析，主要有以下可能性:</p>
<ol>
<li>后台内购支付处理未做足够的校验(划重点)</li>
<li>缓存未维护好，容易被利用刷钱或者是其他BUG(在这个优化需求出来之前，我司APP疑似被利用该BUG刷了几万块的内购币)</li>
<li>支付中断，比如: 请求支付后退出APP，然后支付成功。等等其他类似的情况</li>
<li>其他原因,等等…</li>
</ol>
<h2 id="优化之后的流程"><a href="#优化之后的流程" class="headerlink" title="优化之后的流程"></a>优化之后的流程</h2><ol>
<li>同上</li>
<li>同上</li>
<li>同上</li>
<li>直接获取 receipt 、trade_no、 transaction_id 值去向服务器校验</li>
<li>在服务器校验成功后，执行 finishTransaction 操作</li>
<li>如果有丢单，或者无法访问服务器导致校验失败,在下次启动时，会重新走进来状态变化的代理方法</li>
<li>如果服务器校验该收据不合法，也执行 finishTransaction 操作，并提示用户</li>
</ol>
<p>这就是最终优化后的逻辑，这种方法可以保证用户成功支付之后，必然会在服务器校验后结束。</p>
<h2 id="优化之后的问题"><a href="#优化之后的问题" class="headerlink" title="优化之后的问题"></a>优化之后的问题</h2><p>其实，在优化后，还是有问题的，transaction.payment.applicationUsername 经常获取不到。也就没办法在极端情况下获取到 trade_no 、total_fee 这些参数了。</p>
<p>所幸，还有个迂回的解决方案。在苹果服务器校验收据之后，会返回一个 JSON 数据，内容大致如下:</p>
<ul>
<li>environment、environment: 内购环境</li>
<li>bundle_id、application_version: APP包名、版本</li>
<li>in_app: 支付成功返回的数据，未支付成功也会返回JSON，但一定没有这个参数。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: 0,</span><br><span class="line">  &quot;environment&quot;: &quot;Production&quot;,</span><br><span class="line">  &quot;receipt&quot;: &#123;</span><br><span class="line">    &quot;receipt_type&quot;: &quot;Production&quot;,</span><br><span class="line">    &quot;adam_id&quot;: ...,</span><br><span class="line">    &quot;app_item_id&quot;: ...,</span><br><span class="line">    &quot;bundle_id&quot;: &quot;&quot;,</span><br><span class="line">    &quot;application_version&quot;: &quot;&quot;,</span><br><span class="line">    &quot;download_id&quot;: ...,</span><br><span class="line">    &quot;version_external_identifier&quot;: ...,</span><br><span class="line">    &quot;receipt_creation_date&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;receipt_creation_date_ms&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;receipt_creation_date_pst&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;request_date&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;request_date_ms&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;request_date_pst&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;original_purchase_date&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;original_purchase_date_ms&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;original_purchase_date_pst&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;original_application_version&quot;: &quot;...&quot;,</span><br><span class="line">    &quot;in_app&quot;: [&#123;</span><br><span class="line">      &quot;quantity&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;product_id&quot;: &quot;&lt;#product_id#&gt;&quot;,</span><br><span class="line">      &quot;transaction_id&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;original_transaction_id&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;purchase_date&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;purchase_date_ms&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;purchase_date_pst&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;original_purchase_date&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;original_purchase_date_ms&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;original_purchase_date_pst&quot;: &quot;...&quot;,</span><br><span class="line">      &quot;is_trial_period&quot;: &quot;false&quot;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在后台去拿到这个JSON之后，需要做以下处理:</p>
<ol>
<li>首先就要去校验<code>内购环境</code>, 我司方案是先校验不是 <code>&quot;Production&quot;</code> 的话就报错。仅允许内部用户使用沙箱模式(切记:沙箱模式内购不要钱)</li>
<li>然后就校验有木有 <code>in_app</code> 参数，有的话就是正常支付，直接往下走。否则就是异常支付，当错误处理，并返回异常信息。</li>
<li>校验通过后，查看时候有收到 <code>trade_no</code>、<code>total_fee</code> 参数，有就完事大吉，正常处理支付成功逻辑就OK。</li>
<li>如果没有这俩参数，就从 <code>quantity</code>(价格等级) 或者 <code>product_id</code>(内购商品ID) 去生成 <code>total_fee</code></li>
<li>生成 <code>total_fee</code> 之后，<code>trade_no</code> 就可以根据 <code>total_fee</code>、<code>original_purchase_date</code> 以及后台该用户未支付的订单中去匹配最合适的当成支付成功</li>
</ol>
<p>然后就这样，这套方案就基本没什么问题了。主要就是在后台这块儿需要多处理些漏参数的问题，其他都还好。有丢单现象的同学可以试一试这种方法。</p>
<h1 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h1><p>如果你刚开始做内购，对于其中很多东西还不太明白，推荐你看一看贝聊科技的 NewPan 写的这几篇博客。</p>
<ul>
<li><a href="https://juejin.im/post/5a3b14f36fb9a045104aa6c8" target="_blank" rel="noopener">[贝聊科技]贝聊 IAP 实战之满地是坑</a></li>
<li><a href="https://juejin.im/post/5a3b164e6fb9a0450e76466b" target="_blank" rel="noopener">[贝聊科技]贝聊 IAP 实战之见坑填坑</a></li>
<li><a href="https://juejin.im/post/5a3b169151882521033469b4" target="_blank" rel="noopener">[贝聊科技]贝聊 IAP 实战之订单绑定</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/12/02/fastlane-archive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/02/fastlane-archive/" itemprop="url">
                  基于fastlane的实践-通过Archive生成IPA
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-02 07:48:00" itemprop="dateCreated datePublished" datetime="2018-12-02T07:48:00+00:00">2018-12-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前说过想做 <code>基于 <code>AdHoc</code> 打包的文件，自动生成 <code>AppStore</code> 的 <code>ipa</code></code> ,前段时间抽空研究了下,已经测试导出的IPA可以正常上传到App Store。大致步骤如下。</p>
<h1 id="1-gym"><a href="#1-gym" class="headerlink" title="1. gym"></a>1. gym</h1><p>在打包时，指定 archive_path , 保存 archive。(默认的 archive 路径比较复杂)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gym(</span><br><span class="line">    ...</span><br><span class="line">    archive_path:&quot;./MyAppV1.0.xcarchive&quot;)</span><br></pre></td></tr></table></figure>
<h1 id="2-exportOptionsPlist"><a href="#2-exportOptionsPlist" class="headerlink" title="2. exportOptionsPlist"></a>2. exportOptionsPlist</h1><p>在转换时需要该文件，该文件的内容其实就是相当于手动导出时选的那些参数、配置。</p>
<p>获取方法其实就是通过 Xcode 手动转换导出一次，然后从导出的文件夹下找到 ExportOptions.plist。</p>
<p>如果不是很懂的话，可以参考这篇文章 <a href="https://blog.csdn.net/lovechris00/article/details/79141752" target="_blank" rel="noopener">iOS 生成 exportOptionsPlist 文件</a></p>
<h1 id="3-xcodebuild"><a href="#3-xcodebuild" class="headerlink" title="3.xcodebuild"></a>3.xcodebuild</h1><p>下边就是整个导出IPA的指令，主要修改的参数有三个:</p>
<ul>
<li>archivePath: 步骤1中设置的路径</li>
<li>exportOptionsPlist: 步骤2中导出的配置文件。建议放在同一个目录下</li>
<li>exportPath: 导出IPA的路径</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -exportArchive -archivePath ./MyAppV1.0.xcarchive -exportOptionsPlist ./ExportOptions.plist -exportPath ~/Download/MyAppV1.0.ipa</span><br></pre></td></tr></table></figure>
<p>成功后，可以进一步与 deliver 整合，自动化转换上传，美滋滋。(这一个我还没做)</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-iap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-iap/" itemprop="url">
                  基于fastlane的实践-新建内购项目
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:58:46" itemprop="dateCreated datePublished" datetime="2018-08-18T08:58:46+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>如果APP有内购功能的话，就需要在后台添加内购产品了。如果添加过的话，那么一定会觉得很麻烦。这里用脚本来实现。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ol>
<li>不允许有同名内购项目的存在，删除的内购ID之后没法再使用。</li>
<li>这个脚本本身依赖于 <code>spaceship</code> , 而 <code>spaceship</code> 属于 <code>fastlane</code> 的底层驱动逻辑。具体的可以去看看源代码</li>
<li>这个脚本属于 <code>ruby</code> 脚本，所以可以当成是 <code>ruby</code> 代码执行。</li>
<li>本脚本仅创建消耗品内购产品(CONSUMABLE),其他类型的可以参考实现</li>
</ol>
<h2 id="脚本内容"><a href="#脚本内容" class="headerlink" title="脚本内容"></a>脚本内容</h2><p>有以下几点注意:</p>
<ol>
<li>用户名和密码需要在命令行输入，这个是基于 <code>fastlane</code> 的核心实现的</li>
<li><code>screenshot</code> 表示备注截图，这里使用的同一张图片，请注意</li>
<li>在创建时的 <code>versions</code> 字段中填写国际化信息，此处仅有中文</li>
<li><code>review_notes</code> 表示审核备注信息</li>
<li><code>pricing_intervals</code> 表示价格信息，这里仅固定价格，根据需要调整</li>
<li><code>iap_id</code> 表示内购商品ID固定前缀，按具体情况来做</li>
<li>商品名长度必须大于10，否则会失败。请注意</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">require &quot;spaceship&quot;</span><br><span class="line"></span><br><span class="line"># 参数</span><br><span class="line"></span><br><span class="line">## 用户名和密码</span><br><span class="line">username = &quot;在此处填入APPLE账号&quot;</span><br><span class="line">password = &quot;在此处填入APPLE密码&quot;          </span><br><span class="line"></span><br><span class="line">## APPID</span><br><span class="line">appid = &quot;在此处填入应用ID&quot; </span><br><span class="line">## 屏幕快照路径</span><br><span class="line">screenshot = &quot;在此处填入屏幕快照路径&quot;</span><br><span class="line"></span><br><span class="line"># 登录账号</span><br><span class="line">Spaceship::Tunes.login(username, password)</span><br><span class="line"># 获取指定APP</span><br><span class="line">app = Spaceship::Tunes::Application.find(appid)</span><br><span class="line"></span><br><span class="line"># 创建新的内购项目</span><br><span class="line"></span><br><span class="line">## 内购商品ID格式，可按需求来实现</span><br><span class="line">iap_id = &quot;#&#123;appid&#125;.offical.&quot;</span><br><span class="line"></span><br><span class="line">## 消耗型项目</span><br><span class="line">## 6元=36个钻石</span><br><span class="line">## 18元=120钻石</span><br><span class="line">## 30元=206个钻石</span><br><span class="line">## 98元=678个钻石</span><br><span class="line">## 268元=1868个钻石</span><br><span class="line">## 548元=3828个钻石</span><br><span class="line"></span><br><span class="line">## reference 长度必须大于10,tier表示价格等级</span><br><span class="line">iap_items = [</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;07&quot;, &quot;reference&quot; =&gt; &quot;6元 = 36个钻石&quot;, &quot;tier&quot; =&gt; &quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;08&quot;, &quot;reference&quot; =&gt; &quot;18元 = 120钻石&quot;, &quot;tier&quot; =&gt; &quot;3&quot;&#125;,</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;09&quot;, &quot;reference&quot; =&gt; &quot;30元 = 206个钻石&quot;, &quot;tier&quot; =&gt; &quot;7&quot;&#125;,</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;10&quot;, &quot;reference&quot; =&gt; &quot;98元 = 678个钻石&quot;, &quot;tier&quot; =&gt; &quot;15&quot;&#125;,</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;11&quot;, &quot;reference&quot; =&gt; &quot;268元 = 1868个钻石&quot;, &quot;tier&quot; =&gt; &quot;42&quot;&#125;,</span><br><span class="line">    &#123;&quot;id&quot; =&gt; &quot;12&quot;, &quot;reference&quot; =&gt; &quot;548元 = 3828个钻石&quot;, &quot;tier&quot; =&gt; &quot;57&quot;&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">puts &quot;-------开始创建内购项目-------&quot;</span><br><span class="line"></span><br><span class="line">iap_items.each do |item|</span><br><span class="line">    puts &quot;正在创建的内购项目:#&#123;item[&quot;reference&quot;]&#125;&quot;</span><br><span class="line">    ## 实际的创建命令</span><br><span class="line">    app.in_app_purchases.create!(</span><br><span class="line">        ## 内购类型</span><br><span class="line">        type: Spaceship::Tunes::IAPType::CONSUMABLE, </span><br><span class="line">        ## 国际化描述信息</span><br><span class="line">        versions: &#123;</span><br><span class="line">            &quot;zh-Hans&quot; =&gt; &#123;</span><br><span class="line">                name: item[&quot;reference&quot;].gsub(/\s+/, &quot;&quot;),</span><br><span class="line">                description: item[&quot;reference&quot;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        cleared_for_sale: true,</span><br><span class="line">        reference_name: item[&quot;reference&quot;].gsub(/\s+/, &quot;&quot;),</span><br><span class="line">        product_id: &quot;#&#123;iap_id&#125;#&#123;item[&quot;id&quot;]&#125;&quot;,</span><br><span class="line">        review_notes: nil,</span><br><span class="line">        review_screenshot: screenshot,</span><br><span class="line">        ## 价格信息</span><br><span class="line">        pricing_intervals: [</span><br><span class="line">            &#123;</span><br><span class="line">                country: &quot;WW&quot;,</span><br><span class="line">                begin_date: nil,</span><br><span class="line">                end_date: nil,</span><br><span class="line">                tier: item[&quot;tier&quot;].to_i</span><br><span class="line">            &#125;</span><br><span class="line">        ] </span><br><span class="line">    )</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">puts &quot;-------创建内购项目结束-------&quot;</span><br></pre></td></tr></table></figure>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://github.com/fastlane/fastlane/blob/master/spaceship/lib/spaceship/tunes/iap.rb" target="_blank" rel="noopener">https://github.com/fastlane/fastlane/blob/master/spaceship/lib/spaceship/tunes/iap.rb</a></li>
<li><a href="https://andreygordeev.com/2017/09/14/create-iap-records-programmatically/" target="_blank" rel="noopener">https://andreygordeev.com/2017/09/14/create-iap-records-programmatically/</a></li>
<li><a href="https://github.com/fastlane/fastlane/pull/7834" target="_blank" rel="noopener">https://github.com/fastlane/fastlane/pull/7834</a></li>
<li><a href="https://github.com/fastlane/fastlane/issues/8348" target="_blank" rel="noopener">https://github.com/fastlane/fastlane/issues/8348</a></li>
<li><a href="https://github.com/fastlane/fastlane/issues/1631" target="_blank" rel="noopener">https://github.com/fastlane/fastlane/issues/1631</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-tjcsj/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-tjcsj/" itemprop="url">
                  基于fastlane的实践-添加测试机
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:58:06" itemprop="dateCreated datePublished" datetime="2018-08-18T08:58:06+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个呢，其实也不怎么复杂。达到的效果也比较好，可以将减轻工作负担。</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>由于这个比较独立，不依赖与代码。可以单独创建个空白项目。然后编辑 <code>Fastfile</code></p>
<p>主要有以下几点注意:</p>
<ol>
<li>如果这个号有多个证书，可以先将 <code>cert_id: ENV[&quot;CERTID&quot;],</code> 这一行注释掉，然后从打印中找到对应的证书ID再打开</li>
<li>如果仅有一个证书，那么可以将 <code>cert_id: ENV[&quot;CERTID&quot;],</code> 这一行注释掉</li>
<li>具体的值需要通过环境变量来配置的，请注意哦</li>
<li>这里只配置了AdHoc打包文件，如果需要同时更新，可以简单修改一下 <code>sigh</code> 命令那部分</li>
<li><code>register_devices</code> 支持读取文件的，平时可以收集整理好，换新马甲时可以直接读取</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">desc &quot;添加测试机&quot;</span><br><span class="line">lane :tjcsj do</span><br><span class="line"></span><br><span class="line">    keychain_pass = sh(&quot;cat ~/.keychain_pass_file&quot;)</span><br><span class="line">    sh &quot;security unlock-keychain -p #&#123;keychain_pass&#125;&quot;</span><br><span class="line">    unlock_keychain(path: &quot;~/Library/Keychains/login.keychain&quot;, password: &quot;$(cat ~/.keychain_pass_file)&quot;)</span><br><span class="line"></span><br><span class="line">    ## 添加新设备</span><br><span class="line">    register_devices(</span><br><span class="line">        devices: &#123;</span><br><span class="line">            &quot;备注名1&quot; =&gt; &quot;UDID值1&quot;,</span><br><span class="line">            &quot;备注名2&quot; =&gt; &quot;UDID值2&quot;,</span><br><span class="line">        &#125;,</span><br><span class="line">        username: ENV[&quot;USERNAME&quot;]</span><br><span class="line">    )</span><br><span class="line">    ## 更新证书文件到本地</span><br><span class="line">    sigh(</span><br><span class="line">        adhoc: true,                                      # 申请Adhoc版本</span><br><span class="line">        force: true,                                      # 强制更新到所有设备的证书文件</span><br><span class="line">        username: ENV[&quot;USERNAME&quot;],                        # APPLE账号</span><br><span class="line">        app_identifier: ENV[&quot;APPID&quot;],                     # APPID</span><br><span class="line">        cert_id: ENV[&quot;CERTID&quot;],                           </span><br><span class="line">        output_path: ENV[&quot;PPPATH&quot;],                       # 存储证书文件路径</span><br><span class="line">        provisioning_name: ENV[&quot;PPNAME&quot;],                 # 线上证书文件名称</span><br><span class="line">        filename: &quot;#&#123;ENV[&quot;PPNAME&quot;]&#125;.mobileprovision&quot;      # 存储证书文件名称</span><br><span class="line">    )</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-match/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-match/" itemprop="url">
                  基于fastlane的实践-管理证书
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:57:25" itemprop="dateCreated datePublished" datetime="2018-08-18T08:57:25+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>其实本来是打算基于 <a href="https://docs.fastlane.tools/actions/match/" target="_blank" rel="noopener"><code>match</code></a> 做证书管理的，最后还是不符合要求。</p>
<p>其实用法非常简单，查查文档就行了。主要的问题在于无法识别当前是否已经安装过这个账号的证书，就会导致重复创建。</p>
<h2 id="问题-坑"><a href="#问题-坑" class="headerlink" title="问题/坑"></a>问题/坑</h2><ul>
<li>苹果后台限制账号发布证书最多两个，如果包很多就没办法了。但是恰恰我们有些账号下不止一个APP</li>
<li>除非是就一个账号下就一个APP，且多人开发，用这个才有意义</li>
<li>网上好像有人也在研究这个，可以搜索一下有没有解决方案</li>
</ul>
<h2 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建开发与发布证书</span><br><span class="line">lane :setup_certs do</span><br><span class="line">    match(app_identifier:ENV[&quot;APPID&quot;], username:ENV[&quot;USERNAME&quot;], type: &quot;adhoc&quot;, git_url: ENV[&quot;MATCHURL&quot;], shallow_clone: true, skip_docs:true, git_branch:ENV[&quot;APPNAME&quot;])</span><br><span class="line">    match(app_identifier:ENV[&quot;APPID&quot;], username:ENV[&quot;USERNAME&quot;], type: &quot;appstore&quot;, git_url: ENV[&quot;MATCHURL&quot;], shallow_clone: true, skip_docs:true, git_branch:ENV[&quot;APPNAME&quot;])</span><br><span class="line">    match(app_identifier:ENV[&quot;APPID&quot;], username:ENV[&quot;USERNAME&quot;], type: &quot;development&quot;, git_url: ENV[&quot;MATCHURL&quot;], shallow_clone: true, skip_docs:true, git_branch:ENV[&quot;APPNAME&quot;])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="使用证书"><a href="#使用证书" class="headerlink" title="使用证书"></a>使用证书</h2><p>在打包脚本中加上这一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 切换到打包证书</span><br><span class="line">match(app_identifier:ENV[&quot;APPID&quot;], type: gym_type, git_url: ENV[&quot;MATCHURL&quot;], shallow_clone: true, readonly:true, git_branch:ENV[&quot;APPNAME&quot;])</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-gym-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-gym-02/" itemprop="url">
                  基于fastlane的实践-自动化打包(下)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:56:31" itemprop="dateCreated datePublished" datetime="2018-08-18T08:56:31+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上篇说了一些问题，这篇文章就来看一下怎么打包过程。这里就按照步骤来说一下。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>按照我们APP现有的需求，先列举一下:</p>
<ol>
<li>打包的版本号(版本号，编译版本号)必须为偶数(便于优先追踪线上、内测版BUG)</li>
<li>推送到 <code>fir.im</code>，且成功后发送一条消息到钉钉</li>
<li>打包结束自动修改版本号、打标签并推送</li>
<li>由于可能会发测试版给外部用户安装，所以需要发送特定版本号给用户</li>
<li>需要支持打混淆分支，并将版本号同步非混淆分支</li>
</ol>
<h1 id="非混淆分支"><a href="#非混淆分支" class="headerlink" title="非混淆分支"></a>非混淆分支</h1><p>首先，按照常规步骤先走一遍，来看看是如何做的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">desc &quot;打测试包专用&quot;</span><br><span class="line">  lane :fir do</span><br><span class="line">    ...接下来这个步骤的所有命令全部在这里...</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<h2 id="1-解锁远程机器钥匙串"><a href="#1-解锁远程机器钥匙串" class="headerlink" title="1. 解锁远程机器钥匙串"></a>1. 解锁远程机器钥匙串</h2><p>因为我个人本身还是习惯直接通过 <code>ssh</code> 的，所以按照上一篇的加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># unlock_keychain</span><br><span class="line">keychain_pass = sh(&quot;cat ~/.keychain_pass_file&quot;)</span><br><span class="line">sh &quot;security unlock-keychain -p #&#123;keychain_pass&#125;&quot;</span><br><span class="line">unlock_keychain(path: &quot;~/Library/Keychains/login.keychain&quot;, password: &quot;$(cat ~/.keychain_pass_file)&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="2-拉取最新代码，重置本地修改"><a href="#2-拉取最新代码，重置本地修改" class="headerlink" title="2. 拉取最新代码，重置本地修改"></a>2. 拉取最新代码，重置本地修改</h2><p>毕竟我们打包肯定要用最新代码的吧，所以这一步做了一些事，且保证不会和我们上传的有区别:</p>
<ul>
<li>获取到当前的分支名: 有几次发现某些马甲包无法自动识别分支，导致需要手动操作，其中 <code>gsub</code> 表示去除空行、换行符等</li>
<li>然后首先重置一次，再拉取服务器最新代码，其中 <code>--no-edit</code> 表示自动合并，否则可能拉取之后需要手动输入合并信息</li>
<li>最后执行 <code>pod update</code> 并再次重置,主要是有时候更新会导致工程文件变化。使用 <code>--no-repo-update</code> 纯粹是因为网络不好</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># git branch</span><br><span class="line">branch_name = sh(&quot;git rev-parse --symbolic-full-name --abbrev-ref HEAD&quot;).gsub(/\s+/, &quot;&quot;)</span><br><span class="line"></span><br><span class="line"># git pull</span><br><span class="line">sh &quot;git reset --hard&quot;</span><br><span class="line">sh &quot;git pull origin #&#123;branch_name&#125; --no-edit&quot;</span><br><span class="line"></span><br><span class="line"># pod update</span><br><span class="line">sh &quot;pod update --no-repo-update&quot;</span><br><span class="line">sh &quot;git reset --hard&quot;</span><br></pre></td></tr></table></figure>
<h2 id="3-修改版本号"><a href="#3-修改版本号" class="headerlink" title="3. 修改版本号"></a>3. 修改版本号</h2><p>这里有点坑，<code>fastlane</code> 自带的那个 <code>increment_build_number</code> 有点坑，没办法使用。所以只能就手动读取、设置</p>
<ul>
<li>这里做了个兼容，也就是当版本号为x.x.0，或者当前已经为偶数时，会做不同的处理，其他时候为正常+1</li>
<li>#{ENV[“PLISTPATH”]} 表示读取环境变量中 <code>PLISTPATH</code> 的值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># set version</span><br><span class="line">prev_apk_version = get_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleShortVersionString&quot;)</span><br><span class="line">prev_build_version = get_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleVersion&quot;)</span><br><span class="line"></span><br><span class="line">apk_versions = prev_apk_version.split(pattern=&quot;.&quot;)</span><br><span class="line"></span><br><span class="line">step = 1</span><br><span class="line">if apk_versions[2].to_i == 0</span><br><span class="line">    step = 0</span><br><span class="line">elsif (apk_versions[2].to_i % 2) == 0</span><br><span class="line">    step = 2</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">current_apk_version = &quot;#&#123;apk_versions[0]&#125;.#&#123;apk_versions[1]&#125;.#&#123;apk_versions[2].to_i+step&#125;&quot;</span><br><span class="line">current_build_version = &quot;#&#123;prev_build_version.to_i + step&#125;&quot;</span><br><span class="line">next_apk_version = &quot;#&#123;apk_versions[0]&#125;.#&#123;apk_versions[1]&#125;.#&#123;apk_versions[2].to_i+step+1&#125;&quot;</span><br><span class="line">next_build_version = &quot;#&#123;prev_build_version.to_i + step + 1&#125;&quot;</span><br><span class="line"></span><br><span class="line">set_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleShortVersionString&quot;, value: current_apk_version)</span><br><span class="line">set_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleVersion&quot;, value: current_build_version)</span><br></pre></td></tr></table></figure>
<h2 id="4-打包内购包"><a href="#4-打包内购包" class="headerlink" title="4. 打包内购包"></a>4. 打包内购包</h2><p>这个步骤也就是指定了打包目录和打包类型，没什么好说的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># output path</span><br><span class="line">output_name = &quot;#&#123;ENV[&quot;SCHEMA&quot;]&#125;_v#&#123;current_apk_version&#125;.ipa&quot;</span><br><span class="line">output_directory = &quot;~/Desktop/ad-hoc/#&#123;ENV[&quot;TAGNAME&quot;]&#125;/&quot;</span><br><span class="line">output_path = output_directory + output_name</span><br><span class="line"></span><br><span class="line"># gym build</span><br><span class="line">gym(</span><br><span class="line">    scheme: ENV[&quot;SCHEMA&quot;], </span><br><span class="line">    workspace: &quot;ksh3.xcworkspace&quot;, </span><br><span class="line">    include_bitcode: false,</span><br><span class="line">    export_method:&quot;ad-hoc&quot;,</span><br><span class="line">    output_name: output_name,</span><br><span class="line">    output_directory:output_directory)</span><br></pre></td></tr></table></figure>
<h2 id="5-上传、推送消息"><a href="#5-上传、推送消息" class="headerlink" title="5. 上传、推送消息"></a>5. 上传、推送消息</h2><ul>
<li>上传到 <code>fir.im</code> 并从消息中读取到 Release id，这样子可以拼接成指定版本的链接(之前我们都是手动去网站找的，累)</li>
<li>如果没有这个功能的话，建议更新一下。或者直接用 <code>fir publish -s #{ENV[&quot;FIRLINK&quot;]} #{output_path}</code></li>
<li>拼接一条消息推送到钉钉上，方便测试人员下载</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># fir cli &amp; grep Release id</span><br><span class="line">release_id = sh(&quot;fir publish -s #&#123;ENV[&quot;FIRLINK&quot;]&#125; #&#123;output_path&#125; | grep -i &apos;Release id is &apos; | grep -o -E &apos;[a-z0-9]&#123;16,&#125;&apos;&quot;)</span><br><span class="line"></span><br><span class="line"># dingtalk</span><br><span class="line">upload_msg = &quot; #&#123;ENV[&quot;APPNAME&quot;]&#125;v#&#123;current_apk_version&#125;&quot;</span><br><span class="line">upload_url = &quot;https://fir.im/#&#123;ENV[&quot;FIRLINK&quot;]&#125;?release_id=#&#123;release_id&#125;&quot;</span><br><span class="line">dingtalk(access_token:dingtoken, title:upload_msg, message:upload_msg, more_url: upload_url)</span><br></pre></td></tr></table></figure>
<h2 id="6-收尾工作"><a href="#6-收尾工作" class="headerlink" title="6. 收尾工作"></a>6. 收尾工作</h2><ul>
<li>重置一次当前的修改，保证当前环境的干净</li>
<li>再拉取一次服务器代码。如果在打包时有同事提交了代码，就会导致提交时报错误</li>
<li>打标签。这里要注意标签不能重复，否则会报错误</li>
<li>再次修改版本号为开发版本号，也就是单数</li>
<li>提交，推送，结束</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># update tags &amp; version</span><br><span class="line">sh &quot;git reset --hard&quot;</span><br><span class="line">sh &quot;git pull origin #&#123;branch_name&#125; --no-edit&quot;</span><br><span class="line"></span><br><span class="line">sh &quot;git tag #&#123;ENV[&apos;TAGNAME&apos;]&#125;_#&#123;current_apk_version&#125;&quot;</span><br><span class="line"></span><br><span class="line">set_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleShortVersionString&quot;, value: next_apk_version)</span><br><span class="line">set_info_plist_value(path: &quot;#&#123;ENV[&quot;PLISTPATH&quot;]&#125;&quot;, key: &quot;CFBundleVersion&quot;, value: next_build_version)</span><br><span class="line"></span><br><span class="line">sh &quot;git add .&quot;</span><br><span class="line">sh &quot;git commit -a -m &apos;update version&apos;&quot;</span><br><span class="line"></span><br><span class="line">sh &quot;git push origin #&#123;branch_name&#125; --tags&quot;</span><br><span class="line">sh &quot;git push origin #&#123;branch_name&#125;&quot;</span><br></pre></td></tr></table></figure>
<h1 id="混淆分支"><a href="#混淆分支" class="headerlink" title="混淆分支"></a>混淆分支</h1><p>由于马甲包为了上架做了些混淆工作，所以会创建一个单独的 <code>分支名_appstore</code> 的分支作为混淆分支，这样会便于同步最新代码</p>
<p>主要步骤:</p>
<pre><code>1. 拉取非混淆分支最新代码
2. 拼接分支名，切换到非混淆分支
3. 合并非混淆分支代码到非混淆分支(这一步骤需要检查，可能有改动会造成冲突)
4. 通过正常打包逻辑打混淆包
5. 打包结束后，切换到正常分支
6. 遴选到最后更新版本的那条记录到正常分支，然后推送到服务器
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">desc &quot;打混淆包专用&quot;</span><br><span class="line">lane :mix do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># git branch</span><br><span class="line">branch_name = sh(&quot;git rev-parse --symbolic-full-name --abbrev-ref HEAD&quot;).gsub(/\s+/, &quot;&quot;)</span><br><span class="line"># 混淆后的分支名，默认为:分支名_appstore</span><br><span class="line">appstore_branch = &quot;#&#123;branch_name&#125;_appstore&quot;</span><br><span class="line"></span><br><span class="line"># 拉服务器最新代码</span><br><span class="line">sh &quot;git reset --hard&quot;</span><br><span class="line">sh &quot;git pull origin #&#123;branch_name&#125; --no-edit&quot;</span><br><span class="line"></span><br><span class="line"># 切换到混淆分支打包，之后切回来，遴选更新版本的变更到主分支</span><br><span class="line">sh &quot;git checkout #&#123;appstore_branch&#125;&quot;</span><br><span class="line">sh &quot;git pull origin #&#123;appstore_branch&#125;&quot;</span><br><span class="line">sh &quot;git merge #&#123;branch_name&#125;&quot;</span><br><span class="line">fir</span><br><span class="line">sh &quot;git checkout #&#123;branch_name&#125;&quot;</span><br><span class="line">sh &quot;git cherry-pick #&#123;appstore_branch&#125;&quot;</span><br><span class="line">sh &quot;git push origin #&#123;branch_name&#125;&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>其实上边已经把我整个打包脚本代码贴出来了，其中也没有什么敏感信息。</p>
<h2 id="环境变量文件"><a href="#环境变量文件" class="headerlink" title="环境变量文件"></a>环境变量文件</h2><blockquote>
<p>文件保存到和 <code>Fastfile</code> 同级，名称应为 <code>.env.xxx</code>。命令记得带上 <code>fastlane fir --env xxx</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// .env.ksh3</span><br><span class="line">SCHEMA=&quot;&quot;                       # schema的名字</span><br><span class="line">PLISTPATH=&quot;&quot;                    # Info.plist 的位置，路径为相对于程序根目录</span><br><span class="line">FIRLINK=&quot;&quot;                      # fir.im 的短链，如 wcfg2018</span><br><span class="line">APPNAME=&quot;&quot;                      # APP名，中英文随意</span><br><span class="line">TAGNAME=&quot;&quot;                      # git标签名，叫什么随意，不过最好有点意义，可以用拼音或者英文名</span><br></pre></td></tr></table></figure>
<h2 id="Fastfile"><a href="#Fastfile" class="headerlink" title="Fastfile"></a>Fastfile</h2><p>这里我按照上篇的考虑，选择了从远程获取，这样可以始终保持最新版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import_from_git(url: &apos;....git&apos;, path: &apos;Fastfile&apos;)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-gym-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-gym-01/" itemprop="url">
                  基于fastlane的实践-自动化打包(上)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:55:11" itemprop="dateCreated datePublished" datetime="2018-08-18T08:55:11+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>上篇先说一下打包的周边问题(也可以先跳过)，下篇再聚焦于打包本身。</p>
</blockquote>
<h1 id="配置机器"><a href="#配置机器" class="headerlink" title="配置机器"></a>配置机器</h1><p>由于是在其他机器上打包，所以需要:</p>
<ol>
<li>将自己电脑和打包机器在同一个局域网下(或者说同一个WIFI)</li>
<li>在 <code>系统偏好设置</code> -&gt; <code>共享</code> 中打开远程登录、屏幕共享、文件共享三个权限</li>
<li>将马甲包重新命名放在用户目录下，方便单独打包</li>
<li>配置好一份别名，方便直接打包</li>
</ol>
<p>然后平时打包就是通过 <code>访达-&gt;共享屏幕</code> 去访问，或者说 <code>ssh(远程登录)</code> 链接上去。如果需要远程在家的话，可以考虑挂一个 <code>TeamViewer</code></p>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><h2 id="无法读取钥匙串"><a href="#无法读取钥匙串" class="headerlink" title="无法读取钥匙串"></a>无法读取钥匙串</h2><p>如果是通过 <code>ssh方式</code> 远程登录到其他macOS机器上，直接打包可能由于 <code>Keychain</code> 未解锁的问题导致打包失败。</p>
<p>解决办法是在远程机器桌面创建一个登录密码文件,假如当前登录密码为 <code>12345678</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 也可以手动创建一份文件，注意文件名需要和后边的匹配</span><br><span class="line">echo 12345678 &gt; ~/.keychain_pass_file</span><br></pre></td></tr></table></figure>
<p>然后在脚本最前面，加上:</p>
<blockquote>
<p>注意:脚本第一行会打印密码出来。如果对这有顾虑的可以研究换一种方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 解锁远程机器上的钥匙串</span><br><span class="line">keychain_pass = sh(&quot;cat ~/.keychain_pass_file&quot;)</span><br><span class="line">sh &quot;security unlock-keychain -p #&#123;keychain_pass&#125;&quot;</span><br><span class="line">unlock_keychain(path: &quot;~/Library/Keychains/login.keychain&quot;, password: &quot;$(cat ~/.keychain_pass_file)&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="Fastfile共用"><a href="#Fastfile共用" class="headerlink" title="Fastfile共用"></a>Fastfile共用</h2><p>由于有多个马甲包，且可能由不同人负责的，且打包脚本也有可能更新，如何让他们共用同一份Fastfile呢。</p>
<p>稍微查了下资料后，发现有一个 <a href="https://docs.fastlane.tools/advanced/#environment-variables" target="_blank" rel="noopener"><code>环境变量(env)</code></a> 和 <code>远程文件</code> ，完全满足这个需求。</p>
<p>环境变量:</p>
<pre><code>- 类似于 `xcconfig`,配置键值对，然后在 `Fastfile` 中通过 `ENV[&quot;Key&quot;]`来获取不同值
- 在打包时，执行 `fastlane fir --env weixin` , 其中 `weixin` 必须和 `env` 文件名一致，如: `.env.weixin`
</code></pre><p>远程文件: 可以导入远程文件，来实现始终为最新版本的打包脚本</p>
<h2 id="打包在签名时询问密码"><a href="#打包在签名时询问密码" class="headerlink" title="打包在签名时询问密码"></a>打包在签名时询问密码</h2><p>初次打包时，可能会询问密码,这个时候，可以用这一行命令来解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security set-key-partition-list -S apple-tool:,apple: -k &quot;$(cat ~/.keychain_pass_file)&quot; ~/Library/Keychains/login.keychain</span><br></pre></td></tr></table></figure>
<p>也可以到钥匙串里，设置证书的访问控制权限来达到目的。</p>
<p><img src="/images/keychain_access.png" alt="keychain_access.png"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/08/18/fastlane-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/fastlane-overview/" itemprop="url">
                  基于fastlane的实践-大纲
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-18 08:23:42" itemprop="dateCreated datePublished" datetime="2018-08-18T08:23:42+00:00">2018-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本系列不属于入门文章，如果不懂如何安装或者使用的，可以去互联网搜索相关资料</p>
</blockquote>
<p>从去年开始，有断断续续基于 <code>fastlane</code> 做一些工具，这个系列文章算是总结输出一下这段经验。本篇属于大纲。</p>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li><a href="../fastlane-gym-01/">基于fastlane的实践-自动化打包(上)</a></li>
<li><a href="../fastlane-gym-02/">基于fastlane的实践-自动化打包(下)</a></li>
<li><a href="../fastlane-match/">基于fastlane的实践-管理证书</a></li>
<li><a href="../fastlane-tjcsj/">基于fastlane的实践-添加测试机</a></li>
<li><a href="../fastlane-iap/">基于fastlane的实践-新建内购项目</a></li>
<li><a href="/2018/12/02/fastlane-archive/">基于fastlane的实践-通过Archive生成IPA</a></li>
</ul>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>去年入职现在这家公司，每天都会打两次内测包。就去尝试做一些东西来减轻一些人力负担。最后找到一台 <code>mac mini</code> 来做打包。</p>
<p>再之后，因为有了多个新的马甲包，所以又尝试研究了下 <code>管理证书</code>、<code>新建内购项目</code> 这几个东西。</p>
<p>同样，也是由于马甲包的问题，有其他部门或者测试机都需要添加UDID，手动完成这个步骤非常费时间，就同样研究了下。</p>
<h2 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h2><p>最终的成果还算让我满意。效果如下:</p>
<ul>
<li>自动化打包(AdHoc): <ul>
<li>支持远程登录主机打包</li>
<li>支持自动增加、识别版本号，并按序增加</li>
<li>(Git)支持自动拉取，打标签，推送</li>
<li>支持打混淆马甲包，并合并修改到非混淆代码分支</li>
<li>支持推送到 <code>fir.im</code>、发送钉钉消息</li>
<li>支持一份文件+配置文件打不同马甲包</li>
</ul>
</li>
<li>管理证书: 失败，效果不算好</li>
<li>添加新测试机: 成功</li>
<li>新建内购项目: 成功</li>
</ul>
<h2 id="期望做的"><a href="#期望做的" class="headerlink" title="期望做的"></a>期望做的</h2><h3 id="基于-AdHoc-打包的文件，自动生成-AppStore-的-ipa"><a href="#基于-AdHoc-打包的文件，自动生成-AppStore-的-ipa" class="headerlink" title="基于 AdHoc 打包的文件，自动生成 AppStore 的 ipa"></a><del>基于 <code>AdHoc</code> 打包的文件，自动生成 <code>AppStore</code> 的 <code>ipa</code></del></h3><blockquote>
<p>已实现:<a href="/2018/12/02/fastlane-archive/">基于fastlane的实践-通过Archive生成IPA</a></p>
</blockquote>
<p>这一步其实是由于现在上传 <code>App Store</code> 就是基于 <code>Xcode</code> 来做的，可以省去重复打包，而且确保代码和测试过的一致。</p>
<p><code>Xcode</code> 的入口在 <code>Window</code> -&gt; <code>Organzier</code> -&gt; <code>Archives</code> , 然后找到对应的版本，提交或者生成包就行了。</p>
<p>我就在考虑有没有好办法，可以获取到这个路径，然后自动转换成 <code>App Store</code> 的包然后上传提交。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/07/22/AFNetworkActivityLogger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/AFNetworkActivityLogger/" itemprop="url">
                  AFNetworkActivityLogger 源码解读
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-22 13:17:23" itemprop="dateCreated datePublished" datetime="2018-07-22T13:17:23+00:00">2018-07-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><blockquote>
<p>AFNetworkActivityLogger -&gt; 依赖于 <code>AFNetworking</code> 的官方日志组件</p>
</blockquote>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>通过了解这个源码，可以方便定制网络请求日志监控模块。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>这个日志组件本身的实现原理是通过 <code>AFNetworking</code> 的通知来实现的。</p>
<h2 id="类文件总览"><a href="#类文件总览" class="headerlink" title="类文件总览"></a>类文件总览</h2><p>将源码下载下来，打开发现一共就三个类/接口：</p>
<ul>
<li><code>AFNetworkActivityLogger</code>         管理类</li>
<li><code>AFNetworkActivityConsoleLogger</code>  内置的控制台日志实现</li>
<li><code>AFNetworkActivityLoggerProtocol</code> 日志接口/代理</li>
</ul>
<h1 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h1><h2 id="上手使用"><a href="#上手使用" class="headerlink" title="上手使用"></a>上手使用</h2><p>按照 <code>README</code> 上说的，仅需要在启动时加上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[AFNetworkActivityLogger sharedLogger] startLogging];</span><br></pre></td></tr></table></figure>
<h2 id="AFNetworkActivityLogger-类"><a href="#AFNetworkActivityLogger-类" class="headerlink" title="AFNetworkActivityLogger 类"></a><code>AFNetworkActivityLogger</code> 类</h2><p>基本上，作为一个普通使用者而言，这个类一般是整个组件中唯一需要接触到的。</p>
<h3 id="loggers"><a href="#loggers" class="headerlink" title="loggers"></a>loggers</h3><ul>
<li>对外暴露出当前组件中注册过的日志记录器(logger)</li>
<li>内部维护一个单独的可变集合对象，用于做增删操作</li>
</ul>
<h3 id="sharedLogger-init"><a href="#sharedLogger-init" class="headerlink" title="sharedLogger / init"></a>sharedLogger / init</h3><p>在初始化时：</p>
<ul>
<li>初始化一个可变集合对象，用于保存注册过的日志记录器</li>
<li>会初始化一个 <code>AFNetworkActivityConsoleLogger</code> 日志记录器，并通过 <code>addLogger:</code> 方法注册到组件中</li>
</ul>
<h3 id="startLogging-stopLogging"><a href="#startLogging-stopLogging" class="headerlink" title="startLogging / stopLogging"></a>startLogging / stopLogging</h3><p>在 <code>startLogging</code> 时，监听 <code>AFNetworkingTaskDidResumeNotification</code> 、 <code>AFNetworkingTaskDidCompleteNotification</code> 通知事件，并分别绑定到 <code>networkRequestDidStart:</code> 以及 <code>networkRequestDidFinish:</code> 方法上</p>
<p>在 <code>stopLogging</code> 时，取消监听事件，此外，在 <code>dealloc</code> 方法也会调用该方法</p>
<h3 id="setLogLevel"><a href="#setLogLevel" class="headerlink" title="setLogLevel:"></a>setLogLevel:</h3><p>遍历组件中注册过的日志记录器，将其 <code>level</code> 修改成指定值</p>
<h3 id="addLogger-removeLogger"><a href="#addLogger-removeLogger" class="headerlink" title="addLogger: / removeLogger:"></a>addLogger: / removeLogger:</h3><p>在 <code>loggers</code> 中添加 / 移除传入的日志记录器</p>
<h3 id="networkRequestDidStart"><a href="#networkRequestDidStart" class="headerlink" title="networkRequestDidStart:"></a>networkRequestDidStart:</h3><p>在记录请求开始的方法中，主要有以下几个步骤:</p>
<ol>
<li>从通知对象中取出 <code>task</code>、<code>request</code></li>
<li>检测 <code>request</code> 是否存在，不存在就退出，存在就继续执行</li>
<li>将当前时间保存到 <code>task</code> 上，用于在请求结束时计算耗时时间</li>
<li>遍历已注册的日志记录器</li>
<li>检测当前遍历到的日志记录器是否支持过滤，如支持且符合过滤条件，则中断执行</li>
<li>调用日志记录器的 <code>URLSessionTaskDidStart:</code> 方法，记录请求开始事件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">static void * AFNetworkRequestStartDate = &amp;AFNetworkRequestStartDate;</span><br><span class="line"></span><br><span class="line">- (void)networkRequestDidStart:(NSNotification *)notification &#123;</span><br><span class="line">    // #1</span><br><span class="line">    NSURLSessionTask *task = [notification object];</span><br><span class="line">    NSURLRequest *request = task.originalRequest;</span><br><span class="line"></span><br><span class="line">    // #2</span><br><span class="line">    if (!request) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // #3</span><br><span class="line">    objc_setAssociatedObject(notification.object, AFNetworkRequestStartDate, [NSDate date], OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line"></span><br><span class="line">    // #4</span><br><span class="line">    for (id &lt;AFNetworkActivityLoggerProtocol&gt; logger in self.loggers) &#123;</span><br><span class="line"></span><br><span class="line">        // #5</span><br><span class="line">        if (request &amp;&amp; logger.filterPredicate &amp;&amp; [logger.filterPredicate evaluateWithObject:request]) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // #6</span><br><span class="line">        [logger URLSessionTaskDidStart:task];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="networkRequestDidFinish"><a href="#networkRequestDidFinish" class="headerlink" title="networkRequestDidFinish:"></a>networkRequestDidFinish:</h3><p>在记录请求结束的方法中，主要有以下几个步骤:</p>
<ol>
<li>从通知对象中取出 <code>task</code>、<code>request</code> 、<code>response</code> , 以及尝试获取 <code>error</code></li>
<li>如果 <code>request</code> 、<code>response</code> 均为空，则中断执行</li>
<li>从通知对象的 <code>userInfo</code> 取出服务器返回的数据</li>
<li>从 <code>task</code> 中取出请求开始时保存的时间，并计算出请求耗时</li>
<li>遍历，同上</li>
<li>检查过滤，同上</li>
<li>调用日志记录器的 <code>URLSessionTaskDidFinish:withResponseObject:inElapsedTime:withError:</code> 方法，记录请求结束事件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)networkRequestDidFinish:(NSNotification *)notification &#123;</span><br><span class="line">    <span class="comment">// #1</span></span><br><span class="line">    NSURLSessionTask *task = [notification object];</span><br><span class="line">    NSURLRequest *request = task.originalRequest;</span><br><span class="line">    NSURLResponse *response = task.response;</span><br><span class="line">    NSError *error = AFNetworkErrorFromNotification(notification);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #2</span></span><br><span class="line">    <span class="keyword">if</span> (!request &amp;&amp; !response) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #3</span></span><br><span class="line">    id responseObject = nil;</span><br><span class="line">    <span class="keyword">if</span> (notification.userInfo) &#123;</span><br><span class="line">        responseObject = notification.userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #4</span></span><br><span class="line">    NSTimeInterval elapsedTime = [[NSDate date] timeIntervalSinceDate:objc_getAssociatedObject(notification.object, AFNetworkRequestStartDate)];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #5</span></span><br><span class="line">    <span class="keyword">for</span> (id &lt;AFNetworkActivityLoggerProtocol&gt; logger in self.loggers) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #6</span></span><br><span class="line">        <span class="keyword">if</span> (request &amp;&amp; logger.filterPredicate &amp;&amp; [logger.filterPredicate evaluateWithObject:request]) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #7</span></span><br><span class="line">        [logger URLSessionTaskDidFinish:task withResponseObject:responseObject inElapsedTime:elapsedTime withError:error];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AFNetworkActivityLoggerProtocol-代理"><a href="#AFNetworkActivityLoggerProtocol-代理" class="headerlink" title="AFNetworkActivityLoggerProtocol 代理"></a><code>AFNetworkActivityLoggerProtocol</code> 代理</h2><h3 id="日志级别-AFHTTPRequestLoggerLevel"><a href="#日志级别-AFHTTPRequestLoggerLevel" class="headerlink" title="日志级别 AFHTTPRequestLoggerLevel"></a>日志级别 AFHTTPRequestLoggerLevel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSUInteger, AFHTTPRequestLoggerLevel) &#123;</span><br><span class="line">    AFLoggerLevelOff,</span><br><span class="line">    AFLoggerLevelDebug,</span><br><span class="line">    AFLoggerLevelInfo,</span><br><span class="line">    AFLoggerLevelError</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="filterPredicate-、-level"><a href="#filterPredicate-、-level" class="headerlink" title="filterPredicate 、 level"></a>filterPredicate 、 level</h3><p>通过断言或者日志级别来过滤某些日志信息</p>
<h3 id="日志记录器方法"><a href="#日志记录器方法" class="headerlink" title="日志记录器方法"></a>日志记录器方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/// 记录请求开始</span><br><span class="line">- (void)URLSessionTaskDidStart:(NSURLSessionTask *)task;</span><br><span class="line">/// 记录请求结束</span><br><span class="line">- (void)URLSessionTaskDidFinish:(NSURLSessionTask *)task withResponseObject:(id)responseObject inElapsedTime:(NSTimeInterval)elapsedTime withError:(NSError *)error;</span><br></pre></td></tr></table></figure>
<h2 id="AFNetworkActivityConsoleLogger-控制台日志记录器"><a href="#AFNetworkActivityConsoleLogger-控制台日志记录器" class="headerlink" title="AFNetworkActivityConsoleLogger 控制台日志记录器"></a><code>AFNetworkActivityConsoleLogger</code> 控制台日志记录器</h2><p>这个类作为内置的日志记录器，大致实现了应有的功能，可以从中学习如何定制日志记录器</p>
<h3 id="level"><a href="#level" class="headerlink" title="level"></a>level</h3><p>在初始化方法中，设置为 <code>AFLoggerLevelInfo</code></p>
<h3 id="filterPredicate"><a href="#filterPredicate" class="headerlink" title="filterPredicate"></a>filterPredicate</h3><p>未实现过滤器</p>
<h3 id="URLSessionTaskDidStart"><a href="#URLSessionTaskDidStart" class="headerlink" title="URLSessionTaskDidStart:"></a>URLSessionTaskDidStart:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSessionTaskDidStart:(NSURLSessionTask *)task &#123;</span><br><span class="line">    NSURLRequest *request = task.originalRequest;</span><br><span class="line"></span><br><span class="line">    NSString *body = nil;</span><br><span class="line">    if ([request HTTPBody]) &#123;</span><br><span class="line">        body = [[NSString alloc] initWithData:[request HTTPBody] encoding:NSUTF8StringEncoding];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (self.level) &#123;</span><br><span class="line">        case AFLoggerLevelDebug:</span><br><span class="line">            NSLog(@&quot;%@ &apos;%@&apos;: %@ %@&quot;, [request HTTPMethod], [[request URL] absoluteString], [request allHTTPHeaderFields], body);</span><br><span class="line">            break;</span><br><span class="line">        case AFLoggerLevelInfo:</span><br><span class="line">            NSLog(@&quot;%@ &apos;%@&apos;&quot;, [request HTTPMethod], [[request URL] absoluteString]);</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="URLSessionTaskDidFinish-withResponseObject-inElapsedTime-withError"><a href="#URLSessionTaskDidFinish-withResponseObject-inElapsedTime-withError" class="headerlink" title="URLSessionTaskDidFinish:withResponseObject:inElapsedTime:withError:"></a>URLSessionTaskDidFinish:withResponseObject:inElapsedTime:withError:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSessionTaskDidFinish:(NSURLSessionTask *)task withResponseObject:(id)responseObject inElapsedTime:(NSTimeInterval )elapsedTime withError:(NSError *)error &#123;</span><br><span class="line">    NSUInteger responseStatusCode = 0;</span><br><span class="line">    NSDictionary *responseHeaderFields = nil;</span><br><span class="line">    if ([task.response isKindOfClass:[NSHTTPURLResponse class]]) &#123;</span><br><span class="line">        responseStatusCode = (NSUInteger)[(NSHTTPURLResponse *)task.response statusCode];</span><br><span class="line">        responseHeaderFields = [(NSHTTPURLResponse *)task.response allHeaderFields];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (error) &#123;</span><br><span class="line">        switch (self.level) &#123;</span><br><span class="line">            case AFLoggerLevelDebug:</span><br><span class="line">            case AFLoggerLevelInfo:</span><br><span class="line">            case AFLoggerLevelError:</span><br><span class="line">                NSLog(@&quot;[Error] %@ &apos;%@&apos; (%ld) [%.04f s]: %@&quot;, [task.originalRequest HTTPMethod], [[task.response URL] absoluteString], (long)responseStatusCode, elapsedTime, error);</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        switch (self.level) &#123;</span><br><span class="line">            case AFLoggerLevelDebug:</span><br><span class="line">                NSLog(@&quot;%ld &apos;%@&apos; [%.04f s]: %@ %@&quot;, (long)responseStatusCode, [[task.response URL] absoluteString], elapsedTime, responseHeaderFields, responseObject);</span><br><span class="line">                break;</span><br><span class="line">            case AFLoggerLevelInfo:</span><br><span class="line">                NSLog(@&quot;%ld &apos;%@&apos; [%.04f s]&quot;, (long)responseStatusCode, [[task.response URL] absoluteString], elapsedTime);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tangbl93.github.io/2018/04/17/fix-LOG-OBJC-MAYBE-Invalid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="汤~">
      <meta itemprop="description" content="有时候读书是一种巧妙地避开思考的方法">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/13956214">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="汤~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/fix-LOG-OBJC-MAYBE-Invalid/" itemprop="url">
                  Implicit declaration of function 'LOG_OBJC_MAYBE' is invalid in C99
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-17 13:10:00" itemprop="dateCreated datePublished" datetime="2018-04-17T13:10:00+00:00">2018-04-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-31 00:42:55" itemprop="dateModified" datetime="2019-03-31T00:42:55+00:00">2019-03-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h2><p>当在 Podfile 中开启  <code>use_frameworks!</code> 后遇到</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><ol>
<li>将 <code>HTTPLogging.h</code> 文件中的 <code>#import &quot;DDLog.h&quot;</code> 替换为  <code>#import &lt;CocoaLumberjack/CocoaLumberjack.h&gt;</code></li>
<li>在 <code>HTTPLogging.h</code> 文件中添加以下宏定义: </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define HTTP_LOG_OBJC_MAYBE(async, lvl, flg, ctx, frmt, ...) \</span><br><span class="line">do&#123; if(HTTP_LOG_ASYNC_ENABLED) LOG_MAYBE(async, lvl, flg, ctx, nil, sel_getName(_cmd), frmt, ##__VA_ARGS__); &#125; while(0)</span><br><span class="line"></span><br><span class="line">#define HTTP_LOG_C_MAYBE(async, lvl, flg, ctx, frmt, ...) \</span><br><span class="line">do&#123; if(HTTP_LOG_ASYNC_ENABLED) LOG_MAYBE(async, lvl, flg, ctx, nil, __FUNCTION__, frmt, ##__VA_ARGS__); &#125; while(0)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>将 <code>HTTPLogging.h</code> 文件中所有的 <code>LOG_OBJC_MAYBE</code> 替换为 <code>HTTP_LOG_OBJC_MAYBE</code> , <code>LOG_C_MAYBE</code> 替换为 <code>HTTP_LOG_C_MAYBE</code></li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://stackoverflow.com/questions/40084786/cocoahttpserver2-3-implicit-declaration-of-function-log-objc-maybe-is-invalid" target="_blank" rel="noopener">https://stackoverflow.com/questions/40084786/cocoahttpserver2-3-implicit-declaration-of-function-log-objc-maybe-is-invalid</a></p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars3.githubusercontent.com/u/13956214"
                alt="汤~" />
            
              <p class="site-author-name" itemprop="name">汤~</p>
              <p class="site-description motion-element" itemprop="description">有时候读书是一种巧妙地避开思考的方法</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/tangbl93/tangbl93.github.io/issues" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">汤~</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    






  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
